<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ğŸ’œë°ì¼ë¦¬ íƒ€ì´í•‘ğŸ’œ</title>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">
<style>
body {
  margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
  background: #fdebeb; font-family: 'Gowun Batang', serif; position: relative; overflow: hidden;
}
#particleCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

.best-record {
  position: absolute; top: 35px; right: 45px; text-align: right;
  color: #ae97c1; font-size: 15px; letter-spacing: 1px; z-index: 30;
}
.record-item {
  margin-bottom: 8px; /* í•­ëª© ì‚¬ì´ ê°„ê²© */
}
.record-label {
  font-size: 14px; opacity: 0.8;
}
.record-value {
  font-size: 24px; color: #e180c4; font-weight: bold;
  display: inline-block; margin-left: 5px;
  transition: transform 0.2s ease;
}

.reset-btn {
  background: rgba(255, 255, 255, 0.5); border: 1px solid #923e59; border-radius: 10px;
  color: #923e59; font-family: 'Gowun Batang', serif; font-size: 12px; font-weight: bold;
  padding: 4px 10px; cursor: pointer; margin-top: 5px; transition: 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.reset-btn:hover { background: #923e59; color: white; }

.finish-btn {
  position: absolute; bottom: 30px; right: 40px;
  background: #ae97c1; color: white; border: none; border-radius: 20px;
  padding: 10px 20px; font-family: 'Gowun Batang', serif; font-size: 16px;
  cursor: pointer; z-index: 40; box-shadow: 0 4px 10px rgba(174, 151, 193, 0.4);
  transition: transform 0.2s;
}
.finish-btn:hover { transform: scale(1.05); background: #923e59; }

.modal-overlay {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.5); z-index: 100;
  justify-content: center; align-items: center;
}
.modal-content {
  background: white; padding: 40px; border-radius: 20px; text-align: center;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 400px;
  animation: popUp 0.3s ease-out;
}
.modal-title { font-size: 24px; color: #ae97c1; margin-bottom: 20px; font-weight: bold; }
.modal-text { font-size: 18px; color: #555; line-height: 1.6; margin-bottom: 30px; }
.modal-close-btn {
  background: #e180c4; color: white; border: none; padding: 10px 25px;
  border-radius: 15px; font-family: 'Gowun Batang', serif; font-size: 16px; cursor: pointer;
}
@keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.goodbye-screen {
  display: none;
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #fdebeb; z-index: 200;
  flex-direction: column; justify-content: center; align-items: center;
  text-align: center; animation: fadeIn 1s ease;
}
.goodbye-text { font-size: 30px; color: #ae97c1; margin-bottom: 20px; }
.goodbye-sub { font-size: 18px; color: #923e59; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.container { 
  text-align: center; 
  width: 90%; 
  max-width: 900px;
  position: relative; 
  z-index: 20;
  padding: 0 20px; 
  box-sizing: border-box; 
}

.categories { margin-bottom: 14px; }
.categories button {
  margin: 0 6px; padding: 6px 14px; border-radius: 20px; border: none;
  cursor: pointer; background: #ecbecd; color: #923e59; font-family: 'Gowun Batang', serif; transition: 0.3s;
}
.categories button.active { background: #ae97c1; color: white; }
.title { font-size: 22px; color: #ae97c1; margin-bottom: 22px; letter-spacing: 2px; }

.sentence { 
  font-size: 26px; 
  margin-bottom: 26px; 
  color: #e180c4; 
  transition: opacity 0.4s ease; 
  min-height: 40px;
  white-space: normal !important;
  word-break: keep-all;
  word-wrap: break-word;
  line-height: 1.6;
  width: 100%;
}
.fade-out { opacity: 0; }
.correct { color: #869bc9; }
.incorrect { color: #ea7594; }

input {
  width: 100%; 
  max-width: 600px; 
  padding: 14px 18px; font-size: 25px; border-radius: 16px;
  border: none; outline: none; text-align: center; background: #ecbecd; color: #923e59; font-family: 'Gowun Batang', serif;
  box-sizing: border-box;
}

.navigation-hints { margin-top: 25px; }
.nav-buttons { margin-bottom: 10px; }
.nav-buttons button {
  margin: 0 5px; padding: 8px 16px; border-radius: 12px; border: 1px solid #ae97c1;
  background: transparent; color: #ae97c1; cursor: pointer; font-family: 'Gowun Batang', serif; transition: 0.3s;
}
.stats-container { display: flex; justify-content: center; align-items: baseline; gap: 40px; margin-top: 25px; }
.stat-item { font-size: 19px; color: #e180c4; }
.stat-value { font-size: 22px; display: inline-block; min-width: 45px; text-align: left; margin-left: 5px; }
.sparkle { filter: drop-shadow(0 0 6px rgba(255,255,255,0.9)); animation: pulse 0.5s infinite alternate; display: inline-block; }
@keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
.shortcut-guide { font-size: 14px; color: #c36081; margin: 0; opacity: 0.8; }
.shortcut-guide span { background: #ecbecd; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
</style>
</head>

<body>

<canvas id="particleCanvas"></canvas>

<div id="goodbyeScreen" class="goodbye-screen">
  <div class="goodbye-text">ì˜¤ëŠ˜ë„ ìˆ˜ê³  ë§ì•˜ì–´ìš”!ğŸ’œ</div>
  <div class="goodbye-sub">ì°½ì„ ë‹«ê³  ìŠ¤íŠ¸ë ˆì¹­ í•´ì£¼ì„¸ìš”ï¼œï¼ˆï¼¾ï¼ï¼¾ï¼‰ï¼</div>
</div>

<div id="resultModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-title">ìˆ˜ê³ í•˜ì…¨ì–´ìš”!ğŸ’–</div>
    <div class="modal-text" id="resultText">
      ì˜¤ëŠ˜ì˜ íƒ€ì ì—°ìŠµì€<br>
      0ë¶„ ë™ì•ˆ, 0ê°œ ë¬¸ì¥ì„ íƒ€ì´í•‘ í–ˆì–´ìš” ^o^<br>
      ë‚´ì¼ ë˜ ë§Œë‚˜ìš”!
    </div>
    <button class="modal-close-btn" onclick="quitPractice()">ì•ˆë…•!</button>
  </div>
</div>

<div class="best-record">
  <div class="record-item">
    <span class="record-label">ë‚˜ì˜ ìµœê³  ê¸°ë¡</span>
    <span id="bestScore" class="record-value">0</span>
  </div>
  <div class="record-item">
    <span class="record-label">ë‚˜ì˜ í‰ê·  íƒ€ìˆ˜</span>
    <span id="avgScore" class="record-value">0</span>
  </div>
  <button id="resetBtn" class="reset-btn">ìµœê³  ê¸°ë¡ ì´ˆê¸°í™”</button>
</div>

<div class="container">
  <div class="categories">
    <button class="active" data-type="anime">ë§Œí™”</button>
    <button data-type="movie">ì˜í™”</button>
    <button data-type="drama">ë“œë¼ë§ˆ</button>
  </div>
  <div class="title">ì˜¤ëŠ˜ì˜ ë¬¸ì¥</div>
  <div id="sentence" class="sentence"></div>
  <input id="input" placeholder="ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ì³ë³´ì„¸ìš”" autocomplete="off">
  <div class="navigation-hints">
    <div class="nav-buttons">
      <button id="prevBtn">ì´ì „ ë¬¸ì¥</button>
      <button id="nextBtn">ë‹¤ìŒ ë¬¸ì¥</button>
    </div>
    <p class="shortcut-guide">íŒ: ì´ì „ê³¼ ë‹¤ìŒ ë¬¸ì¥ ë‹¨ì¶•í‚¤ <span>Alt + â† / â†’</span> </p>
  </div>
  <div class="stats-container">
    <div class="stat-item">íƒ€ìˆ˜ <span id="speed" class="stat-value">0</span></div>
    <div class="stat-item">ì •í™•ë„ <span id="accuracy" class="stat-value">100</span>%</div>
  </div>
</div>

<button class="finish-btn" onclick="showResult()">ê·¸ë§Œí•˜ê¸°</button>

<script src="data.js"></script> 
<script>
let currentType = "anime", currentSentence = "", startTime = null, endTime = null;
let history = [], historyIndex = -1;
let personalBest = parseInt(localStorage.getItem("dailyTypingBest")) || 0;
let timerInterval = null; 
let sessionStart = Date.now(); 
let completedSentences = 0; 

let totalSpeedSum = 0; 

function getCharJasoCount(char) {
  const code = char.charCodeAt(0);
  if (code >= 0xAC00 && code <= 0xD7A3) {
    const charCode = code - 0xAC00;
    const jong = charCode % 28;
    return 2 + (jong > 0 ? 1 : 0); 
  } 
  return 1; 
}

const canvas = document.getElementById("particleCanvas");
const ctx = canvas.getContext("2d");
let particles = [];
const colors = ["#ffb3ba", "#ffdfba", "#ffffba", "#baffc9", "#bae1ff", "#e0baff"];

function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

class Particle {
  constructor(x, y) {
    this.x = x; this.y = y;
    this.size = Math.random() * 6 + 1;
    this.speedX = Math.random() * 4 - 2;
    this.speedY = Math.random() * 4 - 2;
    this.color = colors[Math.floor(Math.random() * colors.length)];
    this.opacity = 1;
  }
  update() { this.x += this.speedX; this.y += this.speedY; this.opacity -= 0.03; if (this.size > 0.1) this.size -= 0.05; }
  draw() { ctx.globalAlpha = this.opacity; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
}

function createParticles() {
  const inputRect = document.getElementById("input").getBoundingClientRect();
  const x = inputRect.left + Math.random() * inputRect.width;
  const y = inputRect.top + Math.random() * inputRect.height;
  for (let i = 0; i < 6; i++) { particles.push(new Particle(x, y)); }
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let i = 0; i < particles.length; i++) {
    particles[i].update(); particles[i].draw();
    if (particles[i].opacity <= 0) { particles.splice(i, 1); i--; }
  }
  requestAnimationFrame(animateParticles);
}
animateParticles();

const sentenceEl = document.getElementById("sentence"), input = document.getElementById("input");
const speedEl = document.getElementById("speed"), accuracyEl = document.getElementById("accuracy");
const bestScoreEl = document.getElementById("bestScore"), avgScoreEl = document.getElementById("avgScore"); // í‰ê·  ì ìˆ˜ ìš”ì†Œ ì¶”ê°€
const resetBtn = document.getElementById("resetBtn");
const prevBtn = document.getElementById("prevBtn"), nextBtn = document.getElementById("nextBtn");

bestScoreEl.textContent = personalBest;

resetBtn.addEventListener("click", () => {
  if (confirm("ì •ë§ë¡œ ìµœê³  ê¸°ë¡ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?ğŸ¥º")) {
    personalBest = 0;
    localStorage.setItem("dailyTypingBest", 0);
    bestScoreEl.textContent = 0;
  }
});

function showResult() {
  const now = Date.now();
  const totalMinutes = Math.floor((now - sessionStart) / 60000);
  const totalSeconds = Math.floor(((now - sessionStart) % 60000) / 1000);
  
  // ìµœì¢… í‰ê·  íƒ€ìˆ˜ ê³„ì‚°
  const finalAvg = completedSentences > 0 ? Math.floor(totalSpeedSum / completedSentences) : 0;

  let timeStr = "";
  if (totalMinutes > 0) timeStr += `${totalMinutes}ë¶„ `;
  timeStr += `${totalSeconds}ì´ˆ`;

  const textEl = document.getElementById("resultText");
  textEl.innerHTML = `ì˜¤ëŠ˜ì˜ íƒ€ì ì—°ìŠµì€<br>
  <strong>${timeStr}</strong> ë™ì•ˆ, <strong>${completedSentences}ê°œ</strong> ë¬¸ì¥ì„ ì—°ìŠµí–ˆì–´ìš”!^o^<br>
  ì˜¤ëŠ˜ì˜ í‰ê·  íƒ€ìˆ˜ëŠ” <strong>${finalAvg}íƒ€</strong> ì…ë‹ˆë‹¤!<br>
  ë‚´ì¼ ë˜ ë§Œë‚˜ìš”!`;

  document.getElementById("resultModal").style.display = "flex";
}

function quitPractice() {
  window.close();
  document.getElementById("resultModal").style.display = "none";
  document.getElementById("goodbyeScreen").style.display = "flex";
}

function getSpeedColor(speed) {
  if (speed < 100) return "#869bc9"; if (speed < 200) return "#8fbc93";
  if (speed < 300) return "#ffb347"; if (speed < 400) return "#ff6f6f";
  if (speed < 500) return "#ae97c1"; if (speed < 600) return "#e180c4";
  if (speed < 700) return "#f4a6c1"; if (speed < 800) return "#b39ddb";
  if (speed < 900) return "#6fa8dc"; if (speed < 1000) return "#bcdffb";
  return "#d4af37";
}

function updateRealTimeStats() {
  if (!startTime) return;

  const now = endTime || Date.now();
  const elapsedMinutes = Math.max((now - startTime) / 60000, 0.0001);

  let correctStrokes = 0;
  let correctChars = 0;
  const lengthToCompare = Math.min(input.value.length, currentSentence.length);

  for (let i = 0; i < lengthToCompare; i++) {
    if (input.value[i] === currentSentence[i]) {
      correctStrokes += getCharJasoCount(input.value[i]);
      correctChars++;
    }
  }

  const currentSpeed = Math.floor(correctStrokes / elapsedMinutes);
  
  speedEl.textContent = currentSpeed;
  speedEl.style.color = getSpeedColor(currentSpeed);
  if (currentSpeed >= 500) speedEl.classList.add("sparkle"); else speedEl.classList.remove("sparkle");

  const spans = sentenceEl.querySelectorAll("span");
  spans.forEach((span, i) => {
    if (!input.value[i]) span.className = "";
    else if (input.value[i] === span.textContent) { span.className = "correct"; }
    else span.className = "incorrect";
  });
  
  const acc = Math.floor((correctChars / Math.max(lengthToCompare, 1)) * 100) || 100;
  accuracyEl.textContent = acc;
}

function newSentence() {
  clearInterval(timerInterval); 
  timerInterval = null;

  const list = data[currentType];
  if (list.length <= 1) { updateHistory(list[0]); return; }

  const recentLimit = 8;
  const recentHistory = history.slice(-recentLimit); 
  const candidates = list.filter(item => !recentHistory.includes(item));

  let picked;
  if (candidates.length > 0) {
    picked = candidates[Math.floor(Math.random() * candidates.length)];
  } else {
    do { 
      picked = list[Math.floor(Math.random() * list.length)]; 
    } while (picked === currentSentence);
  }
  updateHistory(picked);
}

function updateHistory(picked) {
  history = history.slice(0, historyIndex + 1);
  history.push(picked); historyIndex++;
  displaySentence(picked);
}

function displaySentence(text) {
  sentenceEl.classList.add("fade-out");
  setTimeout(() => {
    currentSentence = text; sentenceEl.innerHTML = ""; input.value = ""; 
    startTime = null; endTime = null;
    
    speedEl.textContent = "0"; speedEl.style.color = getSpeedColor(0); accuracyEl.textContent = "100";
    speedEl.classList.remove("sparkle");
    
    [...currentSentence].forEach(char => {
      const span = document.createElement("span"); span.textContent = char; sentenceEl.appendChild(span);
    });
    sentenceEl.classList.remove("fade-out");
    input.focus();
  }, 200);
}

input.addEventListener("input", () => {
  if (!input.value) { 
    startTime = null; endTime = null; 
    speedEl.textContent = "0"; 
    clearInterval(timerInterval);
    timerInterval = null;
    return; 
  }

  if (!startTime) {
    startTime = Date.now();
    timerInterval = setInterval(updateRealTimeStats, 50); 
  }

  createParticles();

  if (input.value.length >= currentSentence.length && !endTime) {
    endTime = Date.now();
    clearInterval(timerInterval); 
    updateRealTimeStats(); 
  } else if (input.value.length < currentSentence.length) {
    endTime = null;
    if (!timerInterval && startTime) {
      timerInterval = setInterval(updateRealTimeStats, 50);
    }
  }
});

input.addEventListener("keydown", e => {
  if (e.key === "Enter" || e.key === " ") {
    if (input.value.length >= currentSentence.length) {
      e.preventDefault();
      
      const finalSpeed = parseInt(speedEl.textContent.replace(/[^0-9]/g, ""));
      const isPerfect = input.value.startsWith(currentSentence);

      if (isPerfect && finalSpeed > personalBest) {
        personalBest = finalSpeed;
        localStorage.setItem("dailyTypingBest", personalBest);
        bestScoreEl.textContent = personalBest;
        bestScoreEl.style.transform = "scale(1.3)";
        setTimeout(() => bestScoreEl.style.transform = "scale(1)", 200);
      }
      
      if (isPerfect) {
        completedSentences++;
        totalSpeedSum += finalSpeed;
        const currentAvg = Math.floor(totalSpeedSum / completedSentences);
        document.getElementById("avgScore").textContent = currentAvg;
      }
      
      newSentence();
    }
  }
  if (e.key === "ArrowRight" && e.altKey) { e.preventDefault(); if (historyIndex < history.length - 1) { historyIndex++; displaySentence(history[historyIndex]); } else newSentence(); }
  if (e.key === "ArrowLeft" && e.altKey) { e.preventDefault(); if (historyIndex > 0) { historyIndex--; displaySentence(history[historyIndex]); } }
});

prevBtn.addEventListener("click", () => { if (historyIndex > 0) { historyIndex--; displaySentence(history[historyIndex]); } });
nextBtn.addEventListener("click", () => { if (historyIndex < history.length - 1) { historyIndex++; displaySentence(history[historyIndex]); } else newSentence(); });
document.querySelectorAll(".categories button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".categories button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active"); currentType = btn.dataset.type; newSentence();
  });
});
window.onload = newSentence;
</script>
</body>
</html>
